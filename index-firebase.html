<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Das-Vriss: Job & Inventory Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            text-align: center;
            color: white;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .user-info {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .container {
            display: flex;
            flex: 1;
            gap: 0;
        }

        .sidebar {
            width: 250px;
            background: rgba(0, 0, 0, 0.2);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0;
            display: flex;
            flex-direction: column;
        }

        .sidebar-title {
            padding: 20px;
            color: white;
            font-weight: bold;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar nav {
            flex: 1;
            overflow-y: auto;
        }

        .nav-item {
            display: block;
            padding: 15px 20px;
            color: white;
            text-decoration: none;
            border-left: 3px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-left-color: #667eea;
        }

        .nav-item.active {
            background: rgba(255, 255, 255, 0.15);
            border-left-color: #00d4ff;
        }

        .content {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
        }

        .page {
            display: none;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .page.active {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .button-group {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        button:hover {
            background: #764ba2;
            transform: translateY(-2px);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .secondary-btn {
            background: #6c757d;
        }

        .secondary-btn:hover {
            background: #5a6268;
        }

        .danger-btn {
            background: #dc3545;
        }

        .danger-btn:hover {
            background: #c82333;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }

        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .table-responsive {
            width: 100%;
            overflow-x: auto;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #dee2e6;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }

        .modal-header h3 {
            color: #667eea;
            font-size: 20px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 28px;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: auto;
        }

        .close-modal:hover {
            color: #333;
        }

        .alert {
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }

        .alert-success {
            background: #d4edda;
            border-left-color: #28a745;
            color: #155724;
        }

        .alert-error {
            background: #f8d7da;
            border-left-color: #dc3545;
            color: #721c24;
        }

        .job-card {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .job-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateX(5px);
        }

        .job-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .job-card-title {
            font-weight: 600;
            color: #333;
            font-size: 16px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-in-progress {
            background: #cfe2ff;
            color: #084298;
        }

        .status-completed {
            background: #d1e7dd;
            color: #0f5132;
        }

        .status-on-hold {
            background: #f8d7da;
            color: #842029;
        }

        .job-card-info {
            font-size: 13px;
            color: #666;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .photo-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .photo-preview img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 6px;
            cursor: pointer;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .logout-btn {
            margin-top: auto;
            width: 90%;
            margin-left: 5%;
            margin-bottom: 20px;
            background: #dc3545;
        }

        .logout-btn:hover {
            background: #c82333;
        }

        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 400px;
        }

        .login-box h1 {
            color: #667eea;
            margin-bottom: 10px;
            text-align: center;
        }

        .login-box p {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .job-detail {
            background: white;
        }

        .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
            padding-bottom: 15px;
        }

        .detail-header h3 {
            color: #667eea;
            font-size: 20px;
        }

        .detail-row {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 20px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .detail-label {
            font-weight: 600;
            color: #667eea;
        }

        .detail-value {
            color: #333;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                display: flex;
                flex-direction: row;
            }

            .sidebar nav {
                display: flex;
                overflow-x: auto;
                flex: 1;
            }

            .nav-item {
                white-space: nowrap;
                border-left: none;
                border-bottom: 3px solid transparent;
                padding: 10px 15px;
            }

            .nav-item.active {
                border-left: none;
                border-bottom-color: #00d4ff;
            }

            .content {
                padding: 15px;
            }

            .page {
                padding: 15px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .job-card-info {
                grid-template-columns: 1fr;
            }

            .detail-row {
                grid-template-columns: 1fr;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <h1>Das-Vriss</h1>
            <p>Job & Inventory Tracker</p>
            <form id="loginForm" onsubmit="login(event)">
                <div class="form-group">
                    <label for="loginName">Your Name:</label>
                    <input type="text" id="loginName" placeholder="Enter your name" required>
                </div>
                <div class="form-group">
                    <label for="loginRole">Your Role:</label>
                    <select id="loginRole" required>
                        <option value="">Select a role</option>
                        <option value="Admin">Admin</option>
                        <option value="Technician">Technician</option>
                        <option value="Manager">Manager</option>
                        <option value="Customer">Customer</option>
                    </select>
                </div>
                <button type="submit" style="width: 100%;">Login</button>
            </form>
        </div>
    </div>

    <div id="mainApp" style="display: none;">
        <div class="header">
            <h1>‚öôÔ∏è Das-Vriss</h1>
            <div class="user-info" id="userInfo">Not logged in</div>
        </div>

        <div class="container">
            <div class="sidebar">
                <div class="sidebar-title">Menu</div>
                <nav>
                    <a class="nav-item active" data-page="jobs" onclick="switchPage('jobs')">üìã Jobs</a>
                    <a class="nav-item" data-page="customers" onclick="switchPage('customers')">üë• Customers</a>
                    <a class="nav-item" data-page="technicians" onclick="switchPage('technicians')">üîß Technicians</a>
                    <a class="nav-item" data-page="auditLog" onclick="switchPage('auditLog')">üìã Audit Log</a>
                </nav>
                <button class="logout-btn" onclick="logout()">üö™ Logout</button>
            </div>

            <div class="content">
                <!-- Jobs Page -->
                <div id="jobs" class="page active">
                    <h2>Jobs</h2>
                    <div class="button-group">
                        <button onclick="openNewJobModal()">‚ûï New Job</button>
                        <button class="secondary-btn" onclick="loadJobs()">üîÑ Refresh</button>
                    </div>
                    <div id="jobsList"></div>
                </div>

                <!-- Job Detail Page -->
                <div id="jobDetail" class="page">
                    <div class="job-detail">
                        <div class="detail-header">
                            <h3 id="jobDetailTitle"></h3>
                            <button class="secondary-btn" onclick="goBackToJobs()">‚Üê Back</button>
                        </div>
                        <div id="jobDetailContent"></div>
                        <div class="button-group" style="margin-top: 20px;">
                            <button onclick="editCurrentJob()">‚úèÔ∏è Edit</button>
                            <button class="danger-btn" onclick="deleteCurrentJob()">üóëÔ∏è Delete</button>
                            <button class="secondary-btn" onclick="goBackToJobs()">‚Üê Back to Jobs</button>
                        </div>
                    </div>
                </div>

                <!-- Customers Page -->
                <div id="customers" class="page">
                    <h2>Customers</h2>
                    <div class="button-group">
                        <button onclick="openNewCustomerModal()">‚ûï New Customer</button>
                        <button class="secondary-btn" onclick="loadCustomers()">üîÑ Refresh</button>
                    </div>
                    <div id="customersList"></div>
                </div>

                <!-- Technicians Page -->
                <div id="technicians" class="page">
                    <h2>Technicians</h2>
                    <div class="button-group">
                        <button onclick="openNewTechnicianModal()">‚ûï New Technician</button>
                        <button class="secondary-btn" onclick="loadTechnicians()">üîÑ Refresh</button>
                    </div>
                    <div id="techniciansList"></div>
                </div>

                <!-- Audit Log Page -->
                <div id="auditLog" class="page">
                    <h2>Audit Log</h2>
                    <div class="button-group">
                        <button class="secondary-btn" onclick="loadAuditLog()">üîÑ Refresh</button>
                    </div>
                    <div id="auditLogList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="newJobModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>New Job</h3>
                <button class="close-modal" onclick="closeNewJobModal()">&times;</button>
            </div>
            <form id="jobForm" onsubmit="saveJob(event)">
                <div class="form-group">
                    <label for="jobCustomerSelect">Select Existing Customer (Optional):</label>
                    <select id="jobCustomerSelect" onchange="populateCustomerFields()">
                        <option value="">-- Create New Customer --</option>
                    </select>
                </div>

                <h4>Customer Details</h4>
                <div class="form-group">
                    <label for="jobCustomerName">Customer Name:</label>
                    <input type="text" id="jobCustomerName" placeholder="Customer name" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="jobAddress">Address:</label>
                        <input type="text" id="jobAddress" placeholder="Job address" required>
                    </div>
                    <div class="form-group">
                        <label for="jobPhone">Phone:</label>
                        <input type="tel" id="jobPhone" placeholder="Phone number" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="jobEmail">Email:</label>
                    <input type="email" id="jobEmail" placeholder="Email address">
                </div>

                <h4>Job Details</h4>
                <div class="form-group">
                    <label for="jobDescription">Job Description:</label>
                    <textarea id="jobDescription" placeholder="Describe the job" required></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="jobStatus">Status:</label>
                        <select id="jobStatus" required>
                            <option value="pending">Pending</option>
                            <option value="in-progress">In Progress</option>
                            <option value="completed">Completed</option>
                            <option value="on-hold">On Hold</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="jobTechnician">Assign Technician:</label>
                        <select id="jobTechnician">
                            <option value="">-- Unassigned --</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="jobDate">Date:</label>
                        <input type="date" id="jobDate" required>
                    </div>
                    <div class="form-group">
                        <label for="jobTime">Time:</label>
                        <input type="time" id="jobTime" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="jobLocation">Job Location:</label>
                    <input type="text" id="jobLocation" placeholder="Specific location at address">
                </div>

                <div class="form-group">
                    <label for="jobPhotos">Add Photos:</label>
                    <input type="file" id="jobPhotos" multiple accept="image/*">
                    <small>Select multiple images. They will be uploaded to Firebase Storage.</small>
                </div>

                <div class="button-group">
                    <button type="submit">üíæ Save Job</button>
                    <button type="button" class="secondary-btn" onclick="closeNewJobModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div id="editJobModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Job</h3>
                <button class="close-modal" onclick="closeEditJobModal()">&times;</button>
            </div>
            <form id="editJobForm" onsubmit="updateJob(event)">
                <input type="hidden" id="editJobId">

                <h4>Customer Details</h4>
                <div class="form-group">
                    <label for="editJobCustomerName">Customer Name:</label>
                    <input type="text" id="editJobCustomerName" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="editJobAddress">Address:</label>
                        <input type="text" id="editJobAddress" required>
                    </div>
                    <div class="form-group">
                        <label for="editJobPhone">Phone:</label>
                        <input type="tel" id="editJobPhone" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="editJobEmail">Email:</label>
                    <input type="email" id="editJobEmail">
                </div>

                <h4>Job Details</h4>
                <div class="form-group">
                    <label for="editJobDescription">Job Description:</label>
                    <textarea id="editJobDescription" required></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="editJobStatus">Status:</label>
                        <select id="editJobStatus" required>
                            <option value="pending">Pending</option>
                            <option value="in-progress">In Progress</option>
                            <option value="completed">Completed</option>
                            <option value="on-hold">On Hold</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editJobTechnician">Assign Technician:</label>
                        <select id="editJobTechnician">
                            <option value="">-- Unassigned --</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="editJobDate">Date:</label>
                        <input type="date" id="editJobDate" required>
                    </div>
                    <div class="form-group">
                        <label for="editJobTime">Time:</label>
                        <input type="time" id="editJobTime" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="editJobLocation">Job Location:</label>
                    <input type="text" id="editJobLocation">
                </div>

                <div class="form-group">
                    <label>Existing Photos:</label>
                    <div id="editJobPhotoPreview" class="photo-preview"></div>
                </div>

                <div class="form-group">
                    <label for="editJobPhotos">Add More Photos:</label>
                    <input type="file" id="editJobPhotos" multiple accept="image/*">
                </div>

                <div class="button-group">
                    <button type="submit">üíæ Update Job</button>
                    <button type="button" class="secondary-btn" onclick="closeEditJobModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div id="newCustomerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>New Customer</h3>
                <button class="close-modal" onclick="closeNewCustomerModal()">&times;</button>
            </div>
            <form id="customerForm" onsubmit="saveCustomer(event)">
                <div class="form-group">
                    <label for="custName">Customer Name:</label>
                    <input type="text" id="custName" placeholder="Full name" required>
                </div>

                <div class="form-group">
                    <label for="custAddress">Address:</label>
                    <input type="text" id="custAddress" placeholder="Street address" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="custPhone">Phone:</label>
                        <input type="tel" id="custPhone" placeholder="Phone number" required>
                    </div>
                    <div class="form-group">
                        <label for="custEmail">Email:</label>
                        <input type="email" id="custEmail" placeholder="Email address">
                    </div>
                </div>

                <div class="form-group">
                    <label for="custNotes">Notes:</label>
                    <textarea id="custNotes" placeholder="Additional notes about customer"></textarea>
                </div>

                <div class="form-group">
                    <label for="custPhotos">Photos:</label>
                    <input type="file" id="custPhotos" multiple accept="image/*">
                </div>

                <div class="button-group">
                    <button type="submit">üíæ Save Customer</button>
                    <button type="button" class="secondary-btn" onclick="closeNewCustomerModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div id="newTechnicianModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>New Technician</h3>
                <button class="close-modal" onclick="closeNewTechnicianModal()">&times;</button>
            </div>
            <form id="technicianForm" onsubmit="saveTechnician(event)">
                <div class="form-group">
                    <label for="techName">Technician Name:</label>
                    <input type="text" id="techName" placeholder="Full name" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="techPhone">Phone:</label>
                        <input type="tel" id="techPhone" placeholder="Phone number" required>
                    </div>
                    <div class="form-group">
                        <label for="techEmail">Email:</label>
                        <input type="email" id="techEmail" placeholder="Email address">
                    </div>
                </div>

                <div class="form-group">
                    <label for="techSpecialization">Specialization:</label>
                    <input type="text" id="techSpecialization" placeholder="e.g., Plumbing, Electrical">
                </div>

                <div class="form-group">
                    <label for="techEmergencyName">Emergency Contact Name:</label>
                    <input type="text" id="techEmergencyName" placeholder="Name">
                </div>

                <div class="form-group">
                    <label for="techEmergencyPhone">Emergency Contact Phone:</label>
                    <input type="tel" id="techEmergencyPhone" placeholder="Phone number">
                </div>

                <div class="button-group">
                    <button type="submit">üíæ Save Technician</button>
                    <button type="button" class="secondary-btn" onclick="closeNewTechnicianModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase Integration Script -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-storage.js";

        // Your Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyAjD8PMaOyhFvy1HJ_lsQiObYUP0aw0HyA",
            authDomain: "paxton-7a997.firebaseapp.com",
            projectId: "paxton-7a997",
            storageBucket: "paxton-7a997.firebasestorage.app",
            messagingSenderId: "314900464887",
            appId: "1:314900464887:web:edb62980098fa6c8b63ff2"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const storage = getStorage(app);

        let currentFirebaseUser = null;

        // Anonymous login
        signInAnonymously(auth).catch(err => console.error("Auth error:", err));

        onAuthStateChanged(auth, (user) => {
            currentFirebaseUser = user;
            if (user) {
                console.log("Firebase authenticated as:", user.uid);
            }
        });

        // Expose Firebase to main script
        window.firebaseDb = db;
        window.firebaseStorage = storage;
        window.firebaseUser = () => currentFirebaseUser;
        window.firebaseFns = { collection, addDoc, getDocs, doc, updateDoc, deleteDoc, ref, uploadBytes, getDownloadURL, deleteObject, query, where };
    </script>

    <!-- Main Application Script -->
    <script>
        // Data storage - synced with Firebase
        let currentUser = null;
        let jobs = [];
        let customers = [];
        let technicians = [];
        let customerAccessLog = [];
        let auditLog = [];
        let deviceInfo = { ip: 'N/A', mac: 'N/A' };
        let syncInProgress = false;

        // Initialize Firebase data on load
        async function initializeFirebaseData() {
            await Promise.all([
                loadJobsFromFirestore(),
                loadCustomersFromFirestore(),
                loadTechniciansFromFirestore(),
                loadAuditLogsFromFirestore()
            ]);
        }

        // ===== FIREBASE SYNC FUNCTIONS =====

        // Load jobs from Firestore
        async function loadJobsFromFirestore() {
            if (!window.firebaseDb) return;
            try {
                const jobsCol = window.firebaseFns.collection(window.firebaseDb, 'jobs');
                const snapshot = await window.firebaseFns.getDocs(jobsCol);
                jobs = snapshot.docs.map(docSnap => ({
                    id: docSnap.id,
                    ...docSnap.data()
                }));
                console.log("Loaded", jobs.length, "jobs from Firestore");
            } catch (error) {
                console.error("Error loading jobs:", error);
            }
        }

        // Load customers from Firestore
        async function loadCustomersFromFirestore() {
            if (!window.firebaseDb) return;
            try {
                const custsCol = window.firebaseFns.collection(window.firebaseDb, 'customers');
                const snapshot = await window.firebaseFns.getDocs(custsCol);
                customers = snapshot.docs.map(docSnap => ({
                    id: docSnap.id,
                    ...docSnap.data()
                }));
                console.log("Loaded", customers.length, "customers from Firestore");
            } catch (error) {
                console.error("Error loading customers:", error);
            }
        }

        // Load technicians from Firestore
        async function loadTechniciansFromFirestore() {
            if (!window.firebaseDb) return;
            try {
                const techsCol = window.firebaseFns.collection(window.firebaseDb, 'technicians');
                const snapshot = await window.firebaseFns.getDocs(techsCol);
                technicians = snapshot.docs.map(docSnap => ({
                    id: docSnap.id,
                    ...docSnap.data()
                }));
                console.log("Loaded", technicians.length, "technicians from Firestore");
            } catch (error) {
                console.error("Error loading technicians:", error);
            }
        }

        // Load audit logs from Firestore
        async function loadAuditLogsFromFirestore() {
            if (!window.firebaseDb) return;
            try {
                const auditCol = window.firebaseFns.collection(window.firebaseDb, 'auditLogs');
                const snapshot = await window.firebaseFns.getDocs(auditCol);
                auditLog = snapshot.docs.map(docSnap => ({
                    id: docSnap.id,
                    ...docSnap.data()
                }));
                console.log("Loaded", auditLog.length, "audit logs from Firestore");
            } catch (error) {
                console.error("Error loading audit logs:", error);
            }
        }

        // Save job to Firestore
        async function saveJobToFirestore(jobData) {
            if (!window.firebaseDb) return null;
            try {
                const jobsCol = window.firebaseFns.collection(window.firebaseDb, 'jobs');
                const docRef = await window.firebaseFns.addDoc(jobsCol, jobData);
                console.log("Job saved to Firestore with ID:", docRef.id);
                return docRef.id;
            } catch (error) {
                console.error("Error saving job:", error);
                alert("Error saving job to database: " + error.message);
                return null;
            }
        }

        // Update job in Firestore
        async function updateJobInFirestore(jobId, updates) {
            if (!window.firebaseDb) return;
            try {
                const jobRef = window.firebaseFns.doc(window.firebaseDb, 'jobs', jobId);
                await window.firebaseFns.updateDoc(jobRef, updates);
                console.log("Job updated in Firestore:", jobId);
            } catch (error) {
                console.error("Error updating job:", error);
                alert("Error updating job: " + error.message);
            }
        }

        // Delete job from Firestore
        async function deleteJobFromFirestore(jobId) {
            if (!window.firebaseDb) return;
            try {
                const jobRef = window.firebaseFns.doc(window.firebaseDb, 'jobs', jobId);
                await window.firebaseFns.deleteDoc(jobRef);
                console.log("Job deleted from Firestore:", jobId);
            } catch (error) {
                console.error("Error deleting job:", error);
            }
        }

        // Save customer to Firestore
        async function saveCustomerToFirestore(custData) {
            if (!window.firebaseDb) return null;
            try {
                const custsCol = window.firebaseFns.collection(window.firebaseDb, 'customers');
                const docRef = await window.firebaseFns.addDoc(custsCol, custData);
                console.log("Customer saved to Firestore with ID:", docRef.id);
                return docRef.id;
            } catch (error) {
                console.error("Error saving customer:", error);
                alert("Error saving customer: " + error.message);
                return null;
            }
        }

        // Update customer in Firestore
        async function updateCustomerInFirestore(custId, updates) {
            if (!window.firebaseDb) return;
            try {
                const custRef = window.firebaseFns.doc(window.firebaseDb, 'customers', custId);
                await window.firebaseFns.updateDoc(custRef, updates);
                console.log("Customer updated in Firestore:", custId);
            } catch (error) {
                console.error("Error updating customer:", error);
            }
        }

        // Save technician to Firestore
        async function saveTechnicianToFirestore(techData) {
            if (!window.firebaseDb) return null;
            try {
                const techsCol = window.firebaseFns.collection(window.firebaseDb, 'technicians');
                const docRef = await window.firebaseFns.addDoc(techsCol, techData);
                console.log("Technician saved to Firestore with ID:", docRef.id);
                return docRef.id;
            } catch (error) {
                console.error("Error saving technician:", error);
                alert("Error saving technician: " + error.message);
                return null;
            }
        }

        // Upload photo to Firebase Storage
        async function uploadPhotoToStorage(jobId, file) {
            if (!window.firebaseStorage) return null;
            try {
                const path = `jobs/${jobId}/${Date.now()}_${file.name}`;
                const storageRef = window.firebaseFns.ref(window.firebaseStorage, path);
                const snapshot = await window.firebaseFns.uploadBytes(storageRef, file);
                const url = await window.firebaseFns.getDownloadURL(snapshot.ref);
                console.log("Photo uploaded:", path);
                return url;
            } catch (error) {
                console.error("Error uploading photo:", error);
                alert("Error uploading photo: " + error.message);
                return null;
            }
        }

        // Log audit event to Firestore
        async function logAuditEventToFirestore(action, entityType, entityId, details) {
            if (!window.firebaseDb) return;
            try {
                const auditCol = window.firebaseFns.collection(window.firebaseDb, 'auditLogs');
                const entry = {
                    timestamp: new Date().toISOString(),
                    user: currentUser?.name || 'Unknown',
                    action,
                    entityType,
                    entityId: String(entityId),
                    details,
                    ip: deviceInfo.ip,
                    mac: deviceInfo.mac,
                    firebaseUid: window.firebaseUser()?.uid || 'anonymous'
                };
                await window.firebaseFns.addDoc(auditCol, entry);
                auditLog.push(entry);
                console.log("Audit logged:", action);
            } catch (error) {
                console.error("Error logging audit:", error);
            }
        }

        // ===== UI FUNCTIONS =====

        function login(event) {
            event.preventDefault();
            const name = document.getElementById('loginName').value.trim();
            const role = document.getElementById('loginRole').value;
            if (!name) {
                alert('Please enter your name');
                return;
            }
            currentUser = { name, role };
            document.getElementById('userInfo').textContent = `${name} (${role})`;
            
            // Show main app, load Firebase data
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainApp').style.display = 'flex';
            
            initializeFirebaseData().then(() => {
                loadJobs();
                populateCustomerDropdowns();
                populateTechnicianDropdowns();
            });
        }

        function logout() {
            currentUser = null;
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('loginName').value = '';
            document.getElementById('loginRole').value = '';
        }

        function switchPage(pageName) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            
            const page = document.getElementById(pageName);
            if (page) {
                page.classList.add('active');
            }
            
            const navItem = document.querySelector(`[data-page="${pageName}"]`);
            if (navItem) {
                navItem.classList.add('active');
            }
        }

        // ===== JOBS =====

        function openNewJobModal() {
            document.getElementById('jobForm').reset();
            document.getElementById('newJobModal').classList.add('active');
        }

        function closeNewJobModal() {
            document.getElementById('newJobModal').classList.remove('active');
        }

        function closeEditJobModal() {
            document.getElementById('editJobModal').classList.remove('active');
        }

        async function saveJob(event) {
            event.preventDefault();
            const customerId = document.getElementById('jobCustomerSelect').value;
            const customerName = document.getElementById('jobCustomerName').value.trim();
            const address = document.getElementById('jobAddress').value.trim();
            const phone = document.getElementById('jobPhone').value.trim();
            const email = document.getElementById('jobEmail').value.trim();
            const description = document.getElementById('jobDescription').value.trim();
            const status = document.getElementById('jobStatus').value;
            const date = document.getElementById('jobDate').value;
            const time = document.getElementById('jobTime').value;
            const jobLocation = document.getElementById('jobLocation').value.trim();
            const technicianId = document.getElementById('jobTechnician').value;
            const photosInput = document.getElementById('jobPhotos');

            if (!customerName || !address || !phone || !description) {
                alert('Please fill in all required fields');
                return;
            }

            // If creating new customer, save it first
            let linkedCustomerId = customerId;
            if (!customerId) {
                const newCustomer = {
                    name: customerName,
                    address: address,
                    phone: phone,
                    email: email,
                    notes: '',
                    photoUrls: [],
                    createdAt: new Date().toISOString()
                };
                linkedCustomerId = await saveCustomerToFirestore(newCustomer);
                if (!linkedCustomerId) return;
                customers.push({ id: linkedCustomerId, ...newCustomer });
            }

            const getTechnicianName = () => {
                if (!technicianId) return '';
                const tech = technicians.find(t => t.id == technicianId);
                return tech ? tech.name : '';
            };

            // Upload photos to Firebase Storage
            const photoUrls = [];
            for (const file of photosInput.files) {
                const url = await uploadPhotoToStorage('temp', file);
                if (url) photoUrls.push(url);
            }

            const newJob = {
                customerId: linkedCustomerId || null,
                customerName,
                address,
                phone,
                email,
                description,
                status,
                date,
                time,
                jobLocation,
                technicianId: technicianId || null,
                technicianName: getTechnicianName(),
                photoUrls,
                workLog: [],
                createdAt: new Date().toISOString(),
                createdBy: currentUser?.name || 'Unknown'
            };

            const jobId = await saveJobToFirestore(newJob);
            if (jobId) {
                newJob.id = jobId;
                jobs.push(newJob);
                await logAuditEventToFirestore('CREATE', 'Job', jobId, `Created job: ${customerName}`);
                alert('Job created successfully!');
                closeNewJobModal();
                loadJobs();
                populateCustomerDropdowns();
            }
        }

        async function loadJobs() {
            const jobsList = document.getElementById('jobsList');
            if (jobs.length === 0) {
                jobsList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>No jobs yet. Create one to get started!</p></div>';
                return;
            }

            jobsList.innerHTML = jobs.map(job => `
                <div class="job-card" onclick="showJobDetail('${job.id}')">
                    <div class="job-card-header">
                        <div class="job-card-title">${job.customerName}</div>
                        <span class="status-badge status-${job.status}">${job.status.toUpperCase()}</span>
                    </div>
                    <div class="job-card-info">
                        <div>üìç ${job.address}</div>
                        <div>üìÖ ${job.date} ${job.time}</div>
                        <div>üìù ${job.description.substring(0, 50)}...</div>
                        <div>üîß ${job.technicianName || 'Unassigned'}</div>
                    </div>
                </div>
            `).join('');
        }

        function showJobDetail(jobId) {
            const job = jobs.find(j => j.id === jobId);
            if (!job) return;

            document.getElementById('jobDetailTitle').textContent = job.customerName;
            document.getElementById('jobDetail').dataset.currentJobId = jobId;

            const photoHTML = job.photoUrls && job.photoUrls.length > 0
                ? `<div class="photo-preview">${job.photoUrls.map(url => `<img src="${url}" alt="Job photo">`).join('')}</div>`
                : '<p>No photos</p>';

            document.getElementById('jobDetailContent').innerHTML = `
                <div class="detail-row">
                    <span class="detail-label">Status:</span>
                    <span class="detail-value"><span class="status-badge status-${job.status}">${job.status}</span></span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Customer:</span>
                    <span class="detail-value">${job.customerName}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Address:</span>
                    <span class="detail-value">${job.address}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Phone:</span>
                    <span class="detail-value">${job.phone}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Email:</span>
                    <span class="detail-value">${job.email || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Description:</span>
                    <span class="detail-value">${job.description}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Date:</span>
                    <span class="detail-value">${job.date}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Time:</span>
                    <span class="detail-value">${job.time}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Location:</span>
                    <span class="detail-value">${job.jobLocation || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Technician:</span>
                    <span class="detail-value">${job.technicianName || 'Unassigned'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Photos:</span>
                    <span class="detail-value">${photoHTML}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Created:</span>
                    <span class="detail-value">${job.createdAt ? new Date(job.createdAt).toLocaleString() : 'Unknown'}</span>
                </div>
            `;

            switchPage('jobDetail');
        }

        function goBackToJobs() {
            switchPage('jobs');
            loadJobs();
        }

        function editCurrentJob() {
            const jobId = document.getElementById('jobDetail').dataset.currentJobId;
            const job = jobs.find(j => j.id === jobId);
            if (!job) return;

            document.getElementById('editJobId').value = jobId;
            document.getElementById('editJobCustomerName').value = job.customerName;
            document.getElementById('editJobAddress').value = job.address;
            document.getElementById('editJobPhone').value = job.phone;
            document.getElementById('editJobEmail').value = job.email || '';
            document.getElementById('editJobDescription').value = job.description;
            document.getElementById('editJobStatus').value = job.status;
            document.getElementById('editJobDate').value = job.date;
            document.getElementById('editJobTime').value = job.time;
            document.getElementById('editJobLocation').value = job.jobLocation || '';
            document.getElementById('editJobTechnician').value = job.technicianId || '';

            // Load photos
            const photoPreview = document.getElementById('editJobPhotoPreview');
            if (job.photoUrls && job.photoUrls.length > 0) {
                photoPreview.innerHTML = job.photoUrls.map(url => `<img src="${url}" alt="Job photo">`).join('');
            } else {
                photoPreview.innerHTML = '';
            }

            document.getElementById('editJobModal').classList.add('active');
        }

        async function updateJob(event) {
            event.preventDefault();
            const jobId = document.getElementById('editJobId').value;
            const job = jobs.find(j => j.id === jobId);
            if (!job) return;

            const oldValues = { ...job };
            const technicianId = document.getElementById('editJobTechnician').value;
            const getTechnicianName = () => {
                if (!technicianId) return '';
                const tech = technicians.find(t => t.id == technicianId);
                return tech ? tech.name : '';
            };

            job.customerName = document.getElementById('editJobCustomerName').value.trim();
            job.address = document.getElementById('editJobAddress').value.trim();
            job.phone = document.getElementById('editJobPhone').value.trim();
            job.email = document.getElementById('editJobEmail').value.trim();
            job.description = document.getElementById('editJobDescription').value.trim();
            job.status = document.getElementById('editJobStatus').value;
            job.date = document.getElementById('editJobDate').value;
            job.time = document.getElementById('editJobTime').value;
            job.jobLocation = document.getElementById('editJobLocation').value.trim();
            job.technicianId = technicianId || null;
            job.technicianName = getTechnicianName();

            const changes = [];
            if (oldValues.customerName !== job.customerName) changes.push(`Name: ${oldValues.customerName} ‚Üí ${job.customerName}`);
            if (oldValues.address !== job.address) changes.push(`Address: ${oldValues.address} ‚Üí ${job.address}`);
            if (oldValues.status !== job.status) changes.push(`Status: ${oldValues.status} ‚Üí ${job.status}`);
            
            if (job.status === 'completed' && oldValues.status !== 'completed') {
                job.completedAt = new Date().toISOString();
            }

            // Handle new photos
            const photosInput = document.getElementById('editJobPhotos');
            const existingPhotos = Array.from(document.getElementById('editJobPhotoPreview').querySelectorAll('img')).map(img => img.src);

            for (const file of photosInput.files) {
                const url = await uploadPhotoToStorage(jobId, file);
                if (url) existingPhotos.push(url);
            }
            job.photoUrls = existingPhotos;

            // Update in Firestore
            await updateJobInFirestore(jobId, {
                customerName: job.customerName,
                address: job.address,
                phone: job.phone,
                email: job.email,
                description: job.description,
                status: job.status,
                date: job.date,
                time: job.time,
                jobLocation: job.jobLocation,
                technicianId: job.technicianId,
                technicianName: job.technicianName,
                photoUrls: job.photoUrls,
                completedAt: job.completedAt
            });

            await logAuditEventToFirestore('UPDATE', 'Job', jobId, changes.join('; '));
            alert('Job updated successfully!');
            closeEditJobModal();
            showJobDetail(jobId);
        }

        async function deleteCurrentJob() {
            const jobId = document.getElementById('jobDetail').dataset.currentJobId;
            if (confirm('Are you sure you want to delete this job?')) {
                await deleteJobFromFirestore(jobId);
                jobs = jobs.filter(j => j.id !== jobId);
                await logAuditEventToFirestore('DELETE', 'Job', jobId, 'Job deleted');
                goBackToJobs();
                loadJobs();
            }
        }

        function deleteJob(jobId) {
            if (confirm('Are you sure you want to delete this job?')) {
                deleteJobFromFirestore(jobId);
                jobs = jobs.filter(j => j.id !== jobId);
                logAuditEventToFirestore('DELETE', 'Job', jobId, 'Job deleted');
                loadJobs();
            }
        }

        // ===== CUSTOMERS =====

        function openNewCustomerModal() {
            document.getElementById('customerForm').reset();
            document.getElementById('newCustomerModal').classList.add('active');
        }

        function closeNewCustomerModal() {
            document.getElementById('newCustomerModal').classList.remove('active');
        }

        async function saveCustomer(event) {
            event.preventDefault();
            const name = document.getElementById('custName').value.trim();
            const address = document.getElementById('custAddress').value.trim();
            const phone = document.getElementById('custPhone').value.trim();
            const email = document.getElementById('custEmail').value.trim();
            const notes = document.getElementById('custNotes').value.trim();
            const photosInput = document.getElementById('custPhotos');

            if (!name || !address || !phone) {
                alert('Please fill in all required fields');
                return;
            }

            // Upload photos
            const photoUrls = [];
            for (const file of photosInput.files) {
                const url = await uploadPhotoToStorage('customers', file);
                if (url) photoUrls.push(url);
            }

            const newCustomer = {
                name,
                address,
                phone,
                email,
                notes,
                photoUrls,
                createdAt: new Date().toISOString()
            };

            const custId = await saveCustomerToFirestore(newCustomer);
            if (custId) {
                newCustomer.id = custId;
                customers.push(newCustomer);
                alert('Customer saved successfully!');
                closeNewCustomerModal();
                loadCustomers();
                populateCustomerDropdowns();
            }
        }

        function loadCustomers() {
            const customersList = document.getElementById('customersList');
            if (customers.length === 0) {
                customersList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üë•</div><p>No customers yet. Create one to get started!</p></div>';
                return;
            }

            customersList.innerHTML = `
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Address</th>
                                <th>Phone</th>
                                <th>Email</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${customers.map(cust => `
                                <tr>
                                    <td>${cust.name}</td>
                                    <td>${cust.address}</td>
                                    <td>${cust.phone}</td>
                                    <td>${cust.email || '-'}</td>
                                    <td>${cust.notes || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function populateCustomerDropdowns() {
            const select = document.getElementById('jobCustomerSelect');
            select.innerHTML = '<option value="">-- Create New Customer --</option>' +
                customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }

        function populateCustomerFields() {
            const select = document.getElementById('jobCustomerSelect');
            const customerId = select.value;

            if (!customerId) {
                document.getElementById('jobCustomerName').value = '';
                document.getElementById('jobAddress').value = '';
                document.getElementById('jobPhone').value = '';
                document.getElementById('jobEmail').value = '';
                return;
            }

            const customer = customers.find(c => c.id === customerId);
            if (customer) {
                document.getElementById('jobCustomerName').value = customer.name;
                document.getElementById('jobAddress').value = customer.address;
                document.getElementById('jobPhone').value = customer.phone;
                document.getElementById('jobEmail').value = customer.email || '';
            }
        }

        // ===== TECHNICIANS =====

        function openNewTechnicianModal() {
            document.getElementById('technicianForm').reset();
            document.getElementById('newTechnicianModal').classList.add('active');
        }

        function closeNewTechnicianModal() {
            document.getElementById('newTechnicianModal').classList.remove('active');
        }

        async function saveTechnician(event) {
            event.preventDefault();
            const name = document.getElementById('techName').value.trim();
            const phone = document.getElementById('techPhone').value.trim();
            const email = document.getElementById('techEmail').value.trim();
            const emergencyName = document.getElementById('techEmergencyName').value.trim();
            const emergencyPhone = document.getElementById('techEmergencyPhone').value.trim();
            const specialization = document.getElementById('techSpecialization').value.trim();

            if (!name || !phone) {
                alert('Please fill in required fields');
                return;
            }

            const newTechnician = {
                name,
                phone,
                email,
                emergencyName,
                emergencyPhone,
                specialization,
                createdAt: new Date().toISOString()
            };

            const techId = await saveTechnicianToFirestore(newTechnician);
            if (techId) {
                newTechnician.id = techId;
                technicians.push(newTechnician);
                alert('Technician saved successfully!');
                closeNewTechnicianModal();
                loadTechnicians();
                populateTechnicianDropdowns();
            }
        }

        function loadTechnicians() {
            const techniciansList = document.getElementById('techniciansList');
            if (technicians.length === 0) {
                techniciansList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîß</div><p>No technicians yet. Add one to get started!</p></div>';
                return;
            }

            techniciansList.innerHTML = `
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Phone</th>
                                <th>Email</th>
                                <th>Specialization</th>
                                <th>Emergency Contact</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${technicians.map(tech => `
                                <tr>
                                    <td>${tech.name}</td>
                                    <td>${tech.phone}</td>
                                    <td>${tech.email || '-'}</td>
                                    <td>${tech.specialization || '-'}</td>
                                    <td>${tech.emergencyName ? tech.emergencyName + ' (' + tech.emergencyPhone + ')' : '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function populateTechnicianDropdowns() {
            const selects = [document.getElementById('jobTechnician'), document.getElementById('editJobTechnician')];
            const options = '<option value="">-- Unassigned --</option>' +
                technicians.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
            
            selects.forEach(select => {
                if (select) select.innerHTML = options;
            });
        }

        // ===== AUDIT LOG =====

        function loadAuditLog() {
            const auditLogList = document.getElementById('auditLogList');
            if (auditLog.length === 0) {
                auditLogList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìã</div><p>No audit log entries yet.</p></div>';
                return;
            }

            auditLogList.innerHTML = `
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>User</th>
                                <th>Action</th>
                                <th>Entity</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${auditLog.map(entry => `
                                <tr>
                                    <td>${new Date(entry.timestamp).toLocaleString()}</td>
                                    <td>${entry.user}</td>
                                    <td>${entry.action}</td>
                                    <td>${entry.entityType}</td>
                                    <td>${entry.details}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Set today's date as default
        const today = new Date().toISOString().split('T')[0];
        if (document.getElementById('jobDate')) {
            document.getElementById('jobDate').value = today;
        }

        // Modal close on outside click
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('active');
            }
        });
    </script>
</body>
</html>
